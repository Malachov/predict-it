
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>predictit.main &#8212; predictit 09-07-2020 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for predictit.main</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/python</span>
<span class="c1">#%%</span>
<span class="sd">&quot;&quot;&quot; This is main module for making predictions.</span>

<span class="sd">It contain functions - predict() - More return types - Depends on config</span>
<span class="sd">                     - predict_multiple() - Predict multiple columns at once</span>
<span class="sd">                     - compare_models() - Test on data that was not in test set and compare models errors</span>

<span class="sd">    Examples:</span>

<span class="sd">        &gt;&gt;&gt; import predictit</span>
<span class="sd">        &gt;&gt;&gt; import numpy as np</span>

<span class="sd">        &gt;&gt;&gt; predictions = predictit.main.predict(np.random.randn(1, 100), predicts=3, plot=1)</span>

<span class="sd">Do not edit this file if you are user, it&#39;s not necassary! Only call function from here. The only file to edit is configuration.py. If you are developer, edit as you need.</span>

<span class="sd">There are working examples in main readme and also in test_it module. Particular modules functionality is vissible in visual.py in tests.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">prettytable</span> <span class="k">import</span> <span class="n">PrettyTable</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">multiprocessing</span>

<span class="n">this_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getframeinfo</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">())</span><span class="o">.</span><span class="n">filename</span><span class="p">))</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">this_path_string</span> <span class="o">=</span> <span class="n">this_path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span>

<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">this_path_string</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">predictit</span>

<span class="kn">import</span> <span class="nn">predictit.configuration</span>


<span class="c1"># Frequently used modules save as variables for shorter notation</span>
<span class="n">config</span> <span class="o">=</span> <span class="n">predictit</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">config</span>
<span class="n">traceback_warning</span> <span class="o">=</span> <span class="n">predictit</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">traceback_warning</span>

<span class="n">config</span><span class="o">.</span><span class="n">this_path</span> <span class="o">=</span> <span class="n">this_path</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>

    <span class="c1"># All the config is in configuration.py&quot; - rest only for people that know what are they doing</span>
    <span class="c1"># Add settings from command line if used</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s1">&#39;Prediction framework setting via command line parser!&#39;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--use_config_preset&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;fast&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Edit some selected config, other remains the same, check config_presets.py file.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--used_function&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;predict&#39;</span><span class="p">,</span> <span class="s1">&#39;predict_multiple_columns&#39;</span><span class="p">,</span> <span class="s1">&#39;compare_models&#39;</span><span class="p">,</span> <span class="s1">&#39;validate_predictions&#39;</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Which function in main.py use. Predict predict just one defined column, predict_multiple_columns predict more columns at once, &quot;</span>
                              <span class="s2">&quot;compare_models compare models on defined test data, validate_predictions test models on data not used for training&quot;</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--data_source&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="s1">&#39;test&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;What source of data to use&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--csv_full_path&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Full CSV path with suffix&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--predicts&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Number of predicted values - 7 by default&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--predicted_column&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">eval</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Name of predicted column or it&#39;s index - int &quot;1&quot; or string as &quot;&#39;Name&#39;&quot; &quot;&quot;&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--predicted_columns&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;For predict_multiple_columns function only! List of names of predicted column or it&#39;s indexes&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--freq&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Interval for predictions &#39;M&#39; - months, &#39;D&#39; - Days, &#39;H&#39; - Hours&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--freqs&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">list</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;For predict_multiple_columns function only! List of intervals of predictions &#39;M&#39; - months, &#39;D&#39; - Days, &#39;H&#39; - Hours&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--plot&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If 1, plot interactive graph&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--datetime_index&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Index of dataframe or it&#39;s name. Can be empty, then index 0 or new if no date column.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--return_type&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;best&#39;</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;dict&#39;</span><span class="p">,</span> <span class="s1">&#39;models_error_criterion&#39;</span><span class="p">,</span> <span class="s1">&#39;results_dataframe&#39;</span><span class="p">,</span> <span class="s1">&#39;detailed_results_dictionary&#39;</span><span class="p">],</span>
                        <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;&#39;best&#39; return array of predictions, &#39;all&#39; return more models results sorted by how good they are. &#39;results_dataframe&#39; return results &quot;</span>
                              <span class="s2">&quot;and models names in columns. &#39;detailed_results_dictionary&#39; is used for GUI and return results as best result, all results, string div with &quot;</span>
                              <span class="s2">&quot;plot and more. &#39;models_error_criterion&#39; returns MAPE, RMSE (based on config) or dynamic warping criterion of all models in array.&quot;</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--datalength&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The length of the data used for prediction&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--debug&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Debug - print all results and all the errors on the way&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--analyzeit&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Analyze input data - Statistical distribution, autocorrelation, seasonal decomposition etc.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--optimizeit&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Find optimal parameters of models&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--repeatit&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;How many times is computation repeated&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--other_columns&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;If 0, only predicted column will be used for making predictions.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--default_other_columns_length&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Length of other columns in input vectors&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--lengths&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Compute on various length of data (1, 1/2, 1/4...). Automatically choose the best length. If 0, use only full length.&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--remove_outliers&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">bool</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;Remove extraordinary values. Value is threshold for ignored values. Value means how many times standard &quot;</span>
                                                              <span class="s2">&quot;deviation from the average threshold is far&quot;</span><span class="p">))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--standardizeit&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;standardize&#39;</span><span class="p">,</span> <span class="s1">&#39;-11&#39;</span><span class="p">,</span> <span class="s1">&#39;01&#39;</span><span class="p">,</span> <span class="s1">&#39;robust&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Data standardization, so all columns have similiar scopes&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--error_criterion&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mape&#39;</span><span class="p">,</span> <span class="s1">&#39;rmse&#39;</span><span class="p">],</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Error criterion used for model&quot;</span><span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--print_number_of_models&quot;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;How many models will be displayed in final plot. 0 if only the best one.&quot;</span><span class="p">)</span>

    <span class="c1"># Non empty command line args</span>
    <span class="n">parser_args_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_known_args</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>

    <span class="c1"># Edit config default values with command line arguments values if exist</span>
    <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parser_args_dict</span><span class="p">)</span>


<div class="viewcode-block" id="predict"><a class="viewcode-back" href="../../predictit.main.html#predictit.main.predict">[docs]</a><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="o">**</span><span class="n">function_kwargs</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Make predictions mostly on time-series data. Data input and other config options can be set up in configuration.py or overwritenn on the fly. Setup can be also done</span>
<span class="sd">    as function input arguments or as command line arguments (it will overwrite config values).</span>

<span class="sd">    For all posible arguments run `predictit.configuration.print_config()`</span>

<span class="sd">    There are working examples in main readme and also in test_it module.</span>

<span class="sd">    Args example:</span>
<span class="sd">        data (np.ndarray, pd.DataFrame): Time series. Can be 2-D - more columns.</span>
<span class="sd">            !!! In Numpy array use data series as rows, but in dataframe use cols !!!. If you use CSV, leave it empty. Defaults to [].</span>
<span class="sd">        predicted_column (int, str, optional): Index of predicted column or it&#39;s name (dataframe).</span>
<span class="sd">            If list with more values only the first one will be evaluated (use predict_multiple_columns function if you need that. Defaults to None.</span>
<span class="sd">        predicts (int, optional): Number of predicted values. Defaults to None.</span>

<span class="sd">        **kwargs (dict): There is much more parameters of predict function. Check configuration.py or run predictit.configuration.print_config() for parameters details.</span>

<span class="sd">    Returns:</span>
<span class="sd">        Depend on &#39;return_type&#39; config value - return best prediction {np.ndarray}, all models results {np.ndarray}, detailed results{dict}</span>
<span class="sd">            or interactive plot or print tables of results</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Some global config variables will be updated. But after finishing function, original global config have to be returned</span>
    <span class="n">config_freezed</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>

    <span class="c1"># Define whether to print warnings or not or stop on warnings as on error</span>
    <span class="n">predictit</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">set_warnings</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">debug</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">ignored_warnings</span><span class="p">)</span>

    <span class="n">_GUI</span> <span class="o">=</span> <span class="n">predictit</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">_GUI</span>
    <span class="c1"># Add everything printed + warnings to variable to be able to print in GUI</span>
    <span class="k">if</span> <span class="n">_GUI</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">debug</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">io</span>

        <span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>

    <span class="c1"># Dont want to define in gui condition, so if not gui, do nothing</span>
    <span class="k">if</span> <span class="n">_GUI</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">update_gui</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">predictit</span><span class="o">.</span><span class="n">gui_start</span><span class="o">.</span><span class="n">edit_gui_py</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">update_gui</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
            <span class="k">pass</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">use_config_preset</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">use_config_preset</span> <span class="o">!=</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
        <span class="n">updated_config</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">presets</span><span class="p">[</span><span class="n">config</span><span class="o">.</span><span class="n">use_config_preset</span><span class="p">]</span>
        <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">updated_config</span><span class="p">)</span>

    <span class="c1"># Edit config.py default values with arguments values if exist</span>
    <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">function_kwargs</span><span class="p">)</span>

    <span class="c1"># Do not repeat actually mean evaluate once</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">repeatit</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">repeatit</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># Find difference between original config and set values and if there are any differences, raise error</span>
    <span class="n">config_errors</span> <span class="o">=</span> <span class="nb">set</span><span class="p">({</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;__&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">key</span><span class="p">)}</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">predictit</span><span class="o">.</span><span class="n">configuration</span><span class="o">.</span><span class="n">orig_config</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">config_errors</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">predictit</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">colorize</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Some config values: </span><span class="si">{config_errors}</span><span class="s2"> was named incorrectly. &quot;</span>
                                <span class="s2">&quot;Check config.py for more informations&quot;</span><span class="p">))</span>

    <span class="c1"># Definition of the table for spent time on code parts</span>
    <span class="n">time_parts_table</span> <span class="o">=</span> <span class="n">PrettyTable</span><span class="p">()</span>
    <span class="n">time_parts_table</span><span class="o">.</span><span class="n">field_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Part&quot;</span><span class="p">,</span> <span class="s2">&quot;Time&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">update_time_table</span><span class="p">(</span><span class="n">time_last</span><span class="p">):</span>
        <span class="n">time_parts_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">([</span><span class="n">progress_phase</span><span class="p">,</span> <span class="nb">round</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time_last</span><span class="p">),</span> <span class="mi">3</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">time_point</span> <span class="o">=</span> <span class="n">time_begin</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1">#######################################</span>
    <span class="c1">############## LOAD DATA ####### ANCHOR Data</span>
    <span class="c1">#######################################</span>

    <span class="n">progress_phase</span> <span class="o">=</span> <span class="s2">&quot;Data loading and preprocessing&quot;</span>
    <span class="n">update_gui</span><span class="p">(</span><span class="n">progress_phase</span><span class="p">,</span> <span class="s1">&#39;progress_phase&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">predictit</span><span class="o">.</span><span class="n">data_preprocessing</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="c1">#############################################</span>
    <span class="c1">############ DATA consolidation ###### ANCHOR Data consolidation</span>
    <span class="c1">#############################################</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">predicted_column</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">predicted_column</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">predictit</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">colorize</span><span class="p">(</span><span class="s2">&quot;Data not loaded. Check config.py and use &#39;data_source&#39; - csv and path or assign data to &#39;data&#39;&quot;</span><span class="p">))</span>

    <span class="n">data_for_predictions_orig</span><span class="p">,</span> <span class="n">data_for_predictions_df</span><span class="p">,</span> <span class="n">predicted_column_name</span> <span class="o">=</span> <span class="n">predictit</span><span class="o">.</span><span class="n">data_preprocessing</span><span class="o">.</span><span class="n">data_consolidation</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="c1"># In data consolidation predicted column was replaced on index 0 as first column</span>
    <span class="n">predicted_column_index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;validate&#39;</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">repeatit</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">data_for_predictions_orig</span><span class="p">,</span> <span class="n">test</span> <span class="o">=</span> <span class="n">predictit</span><span class="o">.</span><span class="n">data_preprocessing</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data_for_predictions_orig</span><span class="p">,</span> <span class="n">predicts</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">predicts</span><span class="p">)</span>
        <span class="n">data_for_predictions_df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">predictit</span><span class="o">.</span><span class="n">data_preprocessing</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">data_for_predictions_df</span><span class="p">,</span> <span class="n">predicts</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">predicts</span><span class="p">)</span>

    <span class="c1">########################################</span>
    <span class="c1">############# Data analyze ###### Analyze original data</span>
    <span class="c1">########################################</span>

    <span class="n">multicolumn</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">data_for_predictions_orig</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span>

    <span class="n">column_for_predictions_series</span> <span class="o">=</span> <span class="n">data_for_predictions_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>

    <span class="n">models_names</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">used_models</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">models_number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">models_names</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">used_input_types</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">models_names</span><span class="p">:</span>
        <span class="n">used_input_types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">models_input</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">used_input_types</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">used_input_types</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">analyzeit</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">analyzeit</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Analyze of unprocessed data&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">predictit</span><span class="o">.</span><span class="n">analyze</span><span class="o">.</span><span class="n">analyze_data</span><span class="p">(</span><span class="n">data_for_predictions_orig</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">column_for_predictions_series</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="n">predictit</span><span class="o">.</span><span class="n">analyze</span><span class="o">.</span><span class="n">analyze_correlation</span><span class="p">(</span><span class="n">data_for_predictions_df</span><span class="p">)</span>
            <span class="n">predictit</span><span class="o">.</span><span class="n">analyze</span><span class="o">.</span><span class="n">decompose</span><span class="p">(</span><span class="n">data_for_predictions_orig</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="o">**</span><span class="n">config</span><span class="o">.</span><span class="n">analyze_seasonal_decompose</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">traceback_warning</span><span class="p">(</span><span class="s2">&quot;Analyze failed&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">multiprocessing</span> <span class="o">==</span> <span class="s1">&#39;process&#39;</span><span class="p">:</span>
        <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">pipes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># queues_dict = config.used_models.copy()</span>
        <span class="c1"># for i in queues_dict:</span>
        <span class="c1">#     queues_dict[i] = multiprocessing.Pipe()  # TODO duplex=False</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">multiprocessing</span> <span class="o">==</span> <span class="s1">&#39;pool&#39;</span><span class="p">:</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">()</span>

        <span class="c1"># It is not possible easy share data in multiprocessing, so results are resulted via callback function</span>
        <span class="k">def</span> <span class="nf">return_result</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

    <span class="c1">### Optimization loop</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">optimization</span><span class="p">:</span>
        <span class="n">option_optimization_list</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">optimization_values</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">option_optimization_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Not optimized&#39;</span><span class="p">]</span>
        <span class="n">config</span><span class="o">.</span><span class="n">optimization_variable</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">option_optimization_number</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">option_optimization_list</span><span class="p">)</span>

    <span class="c1"># Empty boxes for results definition</span>
    <span class="c1"># The final result is - [repeated, model, data, results]</span>
    <span class="n">test_results_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">config</span><span class="o">.</span><span class="n">repeatit</span><span class="p">,</span> <span class="n">models_number</span><span class="p">,</span> <span class="n">option_optimization_number</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">predicts</span><span class="p">))</span>
    <span class="n">evaluated_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">config</span><span class="o">.</span><span class="n">repeatit</span><span class="p">,</span> <span class="n">models_number</span><span class="p">,</span> <span class="n">option_optimization_number</span><span class="p">))</span>
    <span class="n">reality_results_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">models_number</span><span class="p">,</span> <span class="n">option_optimization_number</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">predicts</span><span class="p">))</span>
    <span class="n">test_results_matrix</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">evaluated_matrix</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
    <span class="n">reality_results_matrix</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

    <span class="n">time_point</span> <span class="o">=</span> <span class="n">update_time_table</span><span class="p">(</span><span class="n">time_point</span><span class="p">)</span>
    <span class="n">progress_phase</span> <span class="o">=</span> <span class="s2">&quot;Predict&quot;</span>
    <span class="n">update_gui</span><span class="p">(</span><span class="n">progress_phase</span><span class="p">,</span> <span class="s1">&#39;progress_phase&#39;</span><span class="p">)</span>

    <span class="c1">#######################################</span>
    <span class="c1">############# Main loop ######## ANCHOR Main loop</span>
    <span class="c1">#######################################</span>

    <span class="k">for</span> <span class="n">optimization_index</span><span class="p">,</span> <span class="n">optimization_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">option_optimization_list</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">optimization_variable</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">optimization_variable</span> <span class="o">=</span> <span class="n">optimization_value</span>

        <span class="c1"># Some config values are derived from other values. If it has been changed, it has to be updated.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">input_types</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">update_references_input_types</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">optimizeit</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">models_parameters_limits</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">update_references_optimize</span><span class="p">()</span>


        <span class="c1">#############################################</span>
        <span class="c1">############ DATA preprocessing ###### ANCHOR Data preprocessing</span>
        <span class="c1">#############################################</span>

        <span class="n">data_for_predictions</span> <span class="o">=</span> <span class="n">data_for_predictions_orig</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">data_for_predictions</span><span class="p">,</span> <span class="n">last_undiff_value</span><span class="p">,</span> <span class="n">final_scaler</span> <span class="o">=</span> <span class="n">predictit</span><span class="o">.</span><span class="n">data_preprocessing</span><span class="o">.</span><span class="n">preprocess_data</span><span class="p">(</span>
            <span class="n">data_for_predictions</span><span class="p">,</span> <span class="n">predicted_column_index</span><span class="o">=</span><span class="n">predicted_column_index</span><span class="p">,</span> <span class="n">multicolumn</span><span class="o">=</span><span class="n">multicolumn</span><span class="p">,</span>
            <span class="n">remove_outliers</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">remove_outliers</span><span class="p">,</span> <span class="n">smoothit</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">smoothit</span><span class="p">,</span>
            <span class="n">correlation_threshold</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">correlation_threshold</span><span class="p">,</span> <span class="n">data_transform</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">data_transform</span><span class="p">,</span>
            <span class="n">standardizeit</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">standardizeit</span><span class="p">)</span>

        <span class="n">column_for_predictions</span> <span class="o">=</span> <span class="n">data_for_predictions</span><span class="p">[:,</span> <span class="n">predicted_column_index</span><span class="p">]</span>

        <span class="n">data_shape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">data_for_predictions</span><span class="p">)</span>
        <span class="n">data_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">column_for_predictions</span><span class="p">)</span>

        <span class="n">data_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">column_for_predictions</span><span class="p">[</span><span class="o">-</span><span class="mi">30</span><span class="p">:])</span>
        <span class="n">data_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">column_for_predictions</span><span class="p">[</span><span class="o">-</span><span class="mi">30</span><span class="p">:])</span>
        <span class="n">data_abs_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">column_for_predictions</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">column_for_predictions</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span>

        <span class="n">multicolumn</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">data_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">analyzeit</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">analyzeit</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="ow">and</span> <span class="n">optimization_index</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">option_optimization_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2"> Analyze of preprocessed data </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">predictit</span><span class="o">.</span><span class="n">analyze</span><span class="o">.</span><span class="n">analyze_data</span><span class="p">(</span><span class="n">column_for_predictions</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">column_for_predictions</span><span class="p">),</span> <span class="n">window</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">traceback_warning</span><span class="p">(</span><span class="s2">&quot;Analyze failed&quot;</span><span class="p">)</span>

        <span class="n">min_data_length</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">predicts</span> <span class="o">+</span> <span class="n">config</span><span class="o">.</span><span class="n">default_n_steps_in</span>

        <span class="k">if</span> <span class="n">data_length</span> <span class="o">&lt;</span> <span class="n">min_data_length</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">repeatit</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">min_data_length</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">predicts</span> <span class="o">+</span> <span class="n">config</span><span class="o">.</span><span class="n">repeatit</span> <span class="o">*</span> <span class="n">config</span><span class="o">.</span><span class="n">predicts</span> <span class="o">+</span> <span class="n">config</span><span class="o">.</span><span class="n">default_n_steps_in</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;validate&#39;</span><span class="p">:</span>
            <span class="n">models_test_outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">test</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">models_test_outputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">config</span><span class="o">.</span><span class="n">repeatit</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">predicts</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">evaluate_type</span> <span class="o">==</span> <span class="s1">&#39;original&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">repeatit</span><span class="p">):</span>
                    <span class="n">models_test_outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_for_predictions_orig</span><span class="p">[</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">predicts</span> <span class="o">-</span> <span class="n">i</span><span class="p">:</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">data_for_predictions_orig</span><span class="p">[</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">predicts</span> <span class="o">-</span> <span class="n">i</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">evaluate_type</span> <span class="o">==</span> <span class="s1">&#39;preprocessed&#39;</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">repeatit</span><span class="p">):</span>
                    <span class="n">models_test_outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_for_predictions</span><span class="p">[</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">predicts</span> <span class="o">-</span> <span class="n">i</span><span class="p">:</span> <span class="o">-</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">data_for_predictions</span><span class="p">[</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">predicts</span> <span class="o">-</span> <span class="n">i</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span>

            <span class="n">models_test_outputs</span> <span class="o">=</span> <span class="n">models_test_outputs</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">assert</span> <span class="p">(</span><span class="n">min_data_length</span> <span class="o">&lt;</span> <span class="n">data_length</span><span class="p">),</span> <span class="s1">&#39;To few data - set up less repeat value in settings or add more data&#39;</span>

        <span class="k">for</span> <span class="n">input_type</span> <span class="ow">in</span> <span class="n">used_input_types</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">model_train_input</span><span class="p">,</span> <span class="n">model_predict_input</span><span class="p">,</span> <span class="n">model_test_inputs</span> <span class="o">=</span> <span class="n">predictit</span><span class="o">.</span><span class="n">define_inputs</span><span class="o">.</span><span class="n">create_inputs</span><span class="p">(</span><span class="n">input_type</span><span class="p">,</span> <span class="n">data_for_predictions</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">predicted_column_index</span><span class="o">=</span><span class="n">predicted_column_index</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">traceback_warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Error in creating input type: </span><span class="si">{input_type}</span><span class="s2"> with option optimization: </span><span class="si">{optimization_value}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="k">for</span> <span class="n">iterated_model_index</span><span class="p">,</span> <span class="p">(</span><span class="n">iterated_model_name</span><span class="p">,</span> <span class="n">iterated_model</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">used_models</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">models_input</span><span class="p">[</span><span class="n">iterated_model_name</span><span class="p">]</span> <span class="o">==</span> <span class="n">input_type</span><span class="p">:</span>

                    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">models_input</span><span class="p">[</span><span class="n">iterated_model_name</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;one_step&#39;</span><span class="p">,</span> <span class="s1">&#39;one_step_constant&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">multicolumn</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">predicts</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>

                            <span class="n">predictit</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">user_warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;&quot;&quot;Warning in model </span><span class="si">{iterated_model_name}</span><span class="s2"> </span><span class="se">\n\n</span><span class="s2">One-step prediction on multivariate data (more columns).</span>
<span class="s2">                                             Use batch (y lengt equals to predict) or do use some one column data input in config models_input or predict just one value.&quot;&quot;&quot;</span><span class="p">)</span>
                            <span class="k">continue</span>

                    <span class="n">predict_parameters</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span> <span class="s1">&#39;iterated_model_train&#39;</span><span class="p">:</span> <span class="n">iterated_model</span><span class="o">.</span><span class="n">train</span><span class="p">,</span> <span class="s1">&#39;iterated_model_predict&#39;</span><span class="p">:</span> <span class="n">iterated_model</span><span class="o">.</span><span class="n">predict</span><span class="p">,</span> <span class="s1">&#39;iterated_model_name&#39;</span><span class="p">:</span> <span class="n">iterated_model_name</span><span class="p">,</span>
                        <span class="s1">&#39;iterated_model_index&#39;</span><span class="p">:</span> <span class="n">iterated_model_index</span><span class="p">,</span> <span class="s1">&#39;optimization_index&#39;</span><span class="p">:</span> <span class="n">optimization_index</span><span class="p">,</span> <span class="s1">&#39;optimization_value&#39;</span><span class="p">:</span> <span class="n">optimization_value</span><span class="p">,</span>
                        <span class="s1">&#39;option_optimization_list&#39;</span><span class="p">:</span> <span class="n">option_optimization_list</span><span class="p">,</span> <span class="s1">&#39;model_train_input&#39;</span><span class="p">:</span> <span class="n">model_train_input</span><span class="p">,</span> <span class="s1">&#39;model_predict_input&#39;</span><span class="p">:</span> <span class="n">model_predict_input</span><span class="p">,</span>
                        <span class="s1">&#39;model_test_inputs&#39;</span><span class="p">:</span> <span class="n">model_test_inputs</span><span class="p">,</span> <span class="s1">&#39;data_abs_max&#39;</span><span class="p">:</span> <span class="n">data_abs_max</span><span class="p">,</span> <span class="s1">&#39;data_mean&#39;</span><span class="p">:</span> <span class="n">data_mean</span><span class="p">,</span> <span class="s1">&#39;data_std&#39;</span><span class="p">:</span> <span class="n">data_std</span><span class="p">,</span>
                        <span class="s1">&#39;last_undiff_value&#39;</span><span class="p">:</span> <span class="n">last_undiff_value</span><span class="p">,</span> <span class="s1">&#39;models_test_outputs&#39;</span><span class="p">:</span> <span class="n">models_test_outputs</span><span class="p">,</span> <span class="s1">&#39;final_scaler&#39;</span><span class="p">:</span> <span class="n">final_scaler</span>
                    <span class="p">}</span>

                    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">multiprocessing</span> <span class="o">==</span> <span class="s1">&#39;process&#39;</span><span class="p">:</span>
                        <span class="n">pipes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pipe</span><span class="p">())</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">predictit</span><span class="o">.</span><span class="n">main_loop</span><span class="o">.</span><span class="n">train_and_predict</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="o">**</span><span class="n">predict_parameters</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s1">&#39;pipe&#39;</span><span class="p">:</span> <span class="n">pipes</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]}})</span>

                        <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

                    <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">multiprocessing</span> <span class="o">==</span> <span class="s1">&#39;pool&#39;</span><span class="p">:</span>

                        <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">predictit</span><span class="o">.</span><span class="n">main_loop</span><span class="o">.</span><span class="n">train_and_predict</span><span class="p">,</span> <span class="p">(),</span> <span class="n">predict_parameters</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">return_result</span><span class="p">)</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predictit</span><span class="o">.</span><span class="n">main_loop</span><span class="o">.</span><span class="n">train_and_predict</span><span class="p">(</span><span class="o">**</span><span class="n">predict_parameters</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">multiprocessing</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">multiprocessing</span> <span class="o">==</span> <span class="s1">&#39;process&#39;</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">pipes</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">recv</span><span class="p">())</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">multiprocessing</span> <span class="o">==</span> <span class="s1">&#39;pool&#39;</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;results&#39;</span> <span class="ow">and</span> <span class="s1">&#39;evaluated_matrix&#39;</span> <span class="ow">in</span> <span class="n">i</span><span class="p">:</span>
                <span class="n">reality_results_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;results&#39;</span><span class="p">]</span>
                <span class="n">evaluated_matrix</span><span class="p">[:,</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;evaluated_matrix&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="c1"># TODO Do repeate average and more from evaluate in multiprocessing loop and then use sorting as</span>
    <span class="c1"># a = {k: v for k, v in sorted(x.items(), key=lambda item: item[1][&#39;a&#39;])} then use just slicing for plot and print results</span>

    <span class="c1">#############################################</span>
    <span class="c1">############# Evaluate models ######## ANCHOR Evaluate</span>
    <span class="c1">#############################################</span>

    <span class="c1"># Criterion is the best of average from repetitions</span>
    <span class="n">time_point</span> <span class="o">=</span> <span class="n">update_time_table</span><span class="p">(</span><span class="n">time_point</span><span class="p">)</span>
    <span class="n">progress_phase</span> <span class="o">=</span> <span class="s2">&quot;Evaluation&quot;</span>
    <span class="n">update_gui</span><span class="p">(</span><span class="n">progress_phase</span><span class="p">,</span> <span class="s1">&#39;progress_phase&#39;</span><span class="p">)</span>

    <span class="n">repeated_average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">evaluated_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">model_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">repeated_average</span><span class="p">:</span>
        <span class="n">model_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>

    <span class="n">sorted_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">model_results</span><span class="p">)</span>

    <span class="n">predicted_models_for_table</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">predicted_models_for_plot</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sorted_results</span><span class="p">):</span>
        <span class="n">this_model</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">used_models</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">j</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">best_model_name</span> <span class="o">=</span> <span class="n">this_model</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">print_number_of_models</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">.</span><span class="n">print_number_of_models</span><span class="p">:</span>
            <span class="n">predicted_models_for_table</span><span class="p">[</span><span class="n">this_model</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;error_criterion&#39;</span><span class="p">:</span> <span class="n">model_results</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">reality_results_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">repeated_average</span><span class="p">[</span><span class="n">j</span><span class="p">])],</span>
                <span class="s1">&#39;best_config_optimized_value&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">optimization_values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">repeated_average</span><span class="p">[</span><span class="n">j</span><span class="p">])]}</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">plot_number_of_models</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="ow">or</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">config</span><span class="o">.</span><span class="n">plot_number_of_models</span><span class="p">:</span>
            <span class="n">predicted_models_for_plot</span><span class="p">[</span><span class="n">this_model</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;order&#39;</span><span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;error_criterion&#39;</span><span class="p">:</span> <span class="n">model_results</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s1">&#39;predictions&#39;</span><span class="p">:</span> <span class="n">reality_results_matrix</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">repeated_average</span><span class="p">[</span><span class="n">j</span><span class="p">])],</span>
                <span class="s1">&#39;best_config_optimized_value&#39;</span><span class="p">:</span> <span class="n">config</span><span class="o">.</span><span class="n">optimization_values</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">repeated_average</span><span class="p">[</span><span class="n">j</span><span class="p">])]}</span>

    <span class="n">best_model_predicts</span> <span class="o">=</span> <span class="n">predicted_models_for_table</span><span class="p">[</span><span class="n">best_model_name</span><span class="p">][</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="n">best_model_name</span> <span class="ow">in</span> <span class="n">predicted_models_for_table</span> <span class="k">else</span> <span class="s2">&quot;Best model had an error&quot;</span>

    <span class="n">complete_dataframe</span> <span class="o">=</span> <span class="n">column_for_predictions_series</span><span class="p">[</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">plot_history_length</span><span class="p">:]</span><span class="o">.</span><span class="n">to_frame</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">confidence_interval</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lower_bound</span><span class="p">,</span> <span class="n">upper_bound</span> <span class="o">=</span> <span class="n">predictit</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">confidence_interval</span><span class="p">(</span><span class="n">column_for_predictions_series</span><span class="p">,</span> <span class="n">predicts</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">predicts</span><span class="p">,</span> <span class="n">confidence</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">confidence_interval</span><span class="p">)</span>
            <span class="n">complete_dataframe</span><span class="p">[</span><span class="s1">&#39;Lower bound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">complete_dataframe</span><span class="p">[</span><span class="s1">&#39;Upper bound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">bounds</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">traceback_warning</span><span class="p">(</span><span class="s2">&quot;Error in compute confidence interval&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">last_date</span> <span class="o">=</span> <span class="n">column_for_predictions_series</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">last_date</span><span class="p">,</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">datetimes</span><span class="o">.</span><span class="n">DatetimeIndex</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">_libs</span><span class="o">.</span><span class="n">tslibs</span><span class="o">.</span><span class="n">timestamps</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">)):</span>
        <span class="n">date_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">last_date</span><span class="p">,</span> <span class="n">periods</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">predicts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">column_for_predictions_series</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">freq</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">date_index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">date_index</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">date_index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">last_date</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">last_date</span> <span class="o">+</span> <span class="n">config</span><span class="o">.</span><span class="n">predicts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>

    <span class="n">results_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Lower bound&#39;</span><span class="p">:</span> <span class="n">lower_bound</span><span class="p">,</span> <span class="s1">&#39;Upper bound&#39;</span><span class="p">:</span> <span class="n">upper_bound</span><span class="p">},</span> <span class="n">index</span><span class="o">=</span><span class="n">date_index</span><span class="p">)</span> <span class="k">if</span> <span class="n">bounds</span> <span class="k">else</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">date_index</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">predicted_models_for_plot</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;predictions&#39;</span> <span class="ow">in</span> <span class="n">j</span><span class="p">:</span>
            <span class="n">results_dataframe</span><span class="p">[</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{j[&#39;order&#39;]}</span><span class="s2"> - </span><span class="si">{i}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="s1">&#39;predictions&#39;</span><span class="p">]</span>
            <span class="n">complete_dataframe</span><span class="p">[</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{j[&#39;order&#39;]}</span><span class="s2"> - </span><span class="si">{i}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">j</span><span class="p">[</span><span class="s1">&#39;order&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">best_model_name_plot</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{j[&#39;order&#39;]}</span><span class="s2"> - </span><span class="si">{i}</span><span class="s2">&quot;</span>

    <span class="n">results_all_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">date_index</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">optimization</span><span class="p">:</span>
            <span class="n">results_all_dataframe</span><span class="p">[</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{res[&#39;name&#39;]}</span><span class="s2"> - </span><span class="si">{res[&#39;optimization_value&#39;]}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">results_all_dataframe</span><span class="p">[</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{res[&#39;name&#39;]}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;results&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;validate&#39;</span><span class="p">:</span>
        <span class="n">best_model_name_plot</span> <span class="o">=</span> <span class="s1">&#39;Test&#39;</span>
        <span class="n">results_dataframe</span><span class="p">[</span><span class="s1">&#39;Test&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">test</span>

    <span class="n">last_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">column_for_predictions_series</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">complete_dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">complete_dataframe</span><span class="p">,</span> <span class="n">results_dataframe</span><span class="p">],</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">complete_dataframe</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="n">config</span><span class="o">.</span><span class="n">predicts</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_value</span>

    <span class="c1">#######################################</span>
    <span class="c1">############# Plot ############# ANCHOR Plot</span>
    <span class="c1">#######################################</span>

    <span class="n">time_point</span> <span class="o">=</span> <span class="n">update_time_table</span><span class="p">(</span><span class="n">time_point</span><span class="p">)</span>
    <span class="n">progress_phase</span> <span class="o">=</span> <span class="s2">&quot;plot&quot;</span>
    <span class="n">update_gui</span><span class="p">(</span><span class="n">progress_phase</span><span class="p">,</span> <span class="s1">&#39;progress_phase&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">plot</span><span class="p">:</span>

        <span class="k">with</span> <span class="n">warnings</span><span class="o">.</span><span class="n">catch_warnings</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="ne">ResourceWarning</span><span class="p">)</span>

            <span class="n">plot_return</span> <span class="o">=</span> <span class="s1">&#39;div&#39;</span> <span class="k">if</span> <span class="n">_GUI</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span>
            <span class="n">div</span> <span class="o">=</span> <span class="n">predictit</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plotit</span><span class="p">(</span>
                <span class="n">complete_dataframe</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">plot_type</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">show_plot</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">save_plot</span><span class="p">,</span>
                <span class="n">save_path</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">save_plot_path</span><span class="p">,</span> <span class="n">plot_return</span><span class="o">=</span><span class="n">plot_return</span><span class="p">,</span> <span class="n">best_model_name</span><span class="o">=</span><span class="n">best_model_name_plot</span><span class="p">,</span>
                <span class="n">predicted_column_name</span><span class="o">=</span><span class="n">predicted_column_name</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">plot_all_optimized_models</span><span class="p">:</span>
                <span class="n">predictit</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plotit</span><span class="p">(</span>
                    <span class="n">results_all_dataframe</span><span class="p">,</span> <span class="n">plot_type</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">plot_type</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">show_plot</span><span class="p">,</span> <span class="n">save</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">save_plot</span><span class="p">,</span>
                    <span class="n">save_path</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">save_plot_path</span><span class="p">,</span> <span class="n">best_model_name</span><span class="o">=</span><span class="n">best_model_name_plot</span><span class="p">)</span>

    <span class="n">time_point</span> <span class="o">=</span> <span class="n">update_time_table</span><span class="p">(</span><span class="n">time_point</span><span class="p">)</span>
    <span class="n">progress_phase</span> <span class="o">=</span> <span class="s2">&quot;Completed&quot;</span>
    <span class="n">update_gui</span><span class="p">(</span><span class="n">progress_phase</span><span class="p">,</span> <span class="s1">&#39;progress_phase&#39;</span><span class="p">)</span>

    <span class="c1">####################################</span>
    <span class="c1">############# Results ####### ANCHOR Results</span>
    <span class="c1">####################################</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">printit</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">print_result</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">((</span><span class="n">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Best model is </span><span class="si">{best_model_name}</span><span class="s2"> </span><span class="se">\n\t</span><span class="s2"> with results </span><span class="si">{best_model_predicts}</span><span class="s2"> </span><span class="se">\n\t</span><span class="s2"> with model error </span><span class="si">{config.error_criterion}</span><span class="s2"> = &quot;</span>
                   <span class="n">f</span><span class="s2">&quot;</span><span class="si">{predicted_models_for_table[best_model_name][&#39;error_criterion&#39;]}</span><span class="s2">&quot;</span><span class="p">))</span>

        <span class="c1"># Table of results</span>
        <span class="n">models_table</span> <span class="o">=</span> <span class="n">PrettyTable</span><span class="p">()</span>
        <span class="n">models_table</span><span class="o">.</span><span class="n">field_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;Average </span><span class="si">{config.error_criterion}</span><span class="s2"> error&quot;</span><span class="p">]</span>
        <span class="c1"># Fill the table</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">predicted_models_for_table</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">models_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">([</span><span class="n">i</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">j</span><span class="p">[</span><span class="s1">&#39;error_criterion&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)])</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">print_table</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> </span><span class="si">{models_table}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">time_parts_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">([</span><span class="s1">&#39;Complete time&#39;</span><span class="p">,</span> <span class="nb">round</span><span class="p">((</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">time_begin</span><span class="p">),</span> <span class="mi">3</span><span class="p">)])</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">print_time_table</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> </span><span class="si">{time_parts_table}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="c1">### Print detailed resuts ###</span>
        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">print_detailed_result</span><span class="p">:</span>

            <span class="n">detailed_table</span> <span class="o">=</span> <span class="n">PrettyTable</span><span class="p">()</span>
            <span class="n">detailed_table</span><span class="o">.</span><span class="n">field_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Name&#39;</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;Average </span><span class="si">{config.error_criterion}</span><span class="s2"> error&quot;</span><span class="p">,</span> <span class="s1">&#39;Time&#39;</span><span class="p">,</span> <span class="s1">&#39;Config optimization&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">detailed_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">([</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span> <span class="nb">round</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;model_error&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="nb">round</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s1">&#39;model_time&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">),</span> <span class="n">i</span><span class="p">[</span><span class="s1">&#39;optimization_value&#39;</span><span class="p">]])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">optimizeit</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">detailed_table</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="s1">&#39;Optimization time&#39;</span><span class="p">,</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;optimization_time&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">sort_detailed_results_by</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
                <span class="n">detailed_table</span><span class="o">.</span><span class="n">sortby</span> <span class="o">=</span> <span class="s1">&#39;Name&#39;</span>
            <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">sort_detailed_results_by</span> <span class="o">==</span> <span class="s1">&#39;error&#39;</span><span class="p">:</span>
                <span class="n">detailed_table</span><span class="o">.</span><span class="n">sortby</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;Average </span><span class="si">{config.error_criterion}</span><span class="s2"> error&quot;</span>

            <span class="nb">print</span><span class="p">(</span><span class="n">detailed_table</span><span class="p">)</span>

    <span class="n">time_point</span> <span class="o">=</span> <span class="n">update_time_table</span><span class="p">(</span><span class="n">time_point</span><span class="p">)</span>
    <span class="n">progress_phase</span> <span class="o">=</span> <span class="s1">&#39;finished&#39;</span>
    <span class="n">update_gui</span><span class="p">(</span><span class="n">progress_phase</span><span class="p">,</span> <span class="s1">&#39;progress_phase&#39;</span><span class="p">)</span>

    <span class="c1"># Return stdout and stop collect warnings and printed output</span>
    <span class="k">if</span> <span class="n">_GUI</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">stdout</span>

        <span class="nb">print</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

    <span class="c1"># Return original config values before predict function</span>
    <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config_freezed</span><span class="p">)</span>

    <span class="c1">################################</span>
    <span class="c1">########### Return ###### ANCHOR Return</span>
    <span class="c1">################################</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">return_type</span> <span class="o">==</span> <span class="s1">&#39;models_error_criterion&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">repeated_average</span>

    <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">return_type</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">reality_results_matrix</span>

    <span class="k">elif</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">return_type</span> <span class="ow">or</span> <span class="n">config</span><span class="o">.</span><span class="n">return_type</span> <span class="o">==</span> <span class="s1">&#39;best&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">best_model_predicts</span>

    <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">return_type</span> <span class="o">==</span> <span class="s1">&#39;results_dataframe&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">results_dataframe</span>

    <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">return_type</span> <span class="o">==</span> <span class="s1">&#39;detailed_results_dictionary&#39;</span><span class="p">:</span>
        <span class="n">detailed_results_dictionary</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;predicted_models&#39;</span><span class="p">:</span> <span class="n">predicted_models_for_table</span><span class="p">,</span>
            <span class="s1">&#39;best&#39;</span><span class="p">:</span> <span class="n">best_model_predicts</span><span class="p">,</span>
            <span class="s1">&#39;all&#39;</span><span class="p">:</span> <span class="n">reality_results_matrix</span><span class="p">,</span>
            <span class="s1">&#39;time_table&#39;</span><span class="p">:</span> <span class="n">time_parts_table</span><span class="o">.</span><span class="n">get_html_string</span><span class="p">(),</span>
            <span class="s1">&#39;models_table&#39;</span><span class="p">:</span> <span class="n">models_table</span><span class="o">.</span><span class="n">get_html_string</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">_GUI</span><span class="p">:</span>
            <span class="n">detailed_results_dictionary</span><span class="p">[</span><span class="s1">&#39;plot&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">div</span>
            <span class="n">detailed_results_dictionary</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">output</span>

        <span class="k">return</span> <span class="n">detailed_results_dictionary</span>

    <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">return_type</span> <span class="o">==</span> <span class="s1">&#39;visual_check&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;data_for_predictions (X, y)&#39;</span><span class="p">:</span> <span class="n">data_for_predictions</span><span class="p">,</span> <span class="s1">&#39;model_train_input&#39;</span><span class="p">:</span> <span class="n">model_train_input</span><span class="p">,</span>
                <span class="s1">&#39;model_predict_input&#39;</span><span class="p">:</span> <span class="n">model_predict_input</span><span class="p">,</span> <span class="s1">&#39;model_test_inputs&#39;</span><span class="p">:</span> <span class="n">model_test_inputs</span><span class="p">,</span> <span class="s1">&#39;models_test_outputs&#39;</span><span class="p">:</span> <span class="n">models_test_outputs</span><span class="p">}</span></div>


<div class="viewcode-block" id="predict_multiple_columns"><a class="viewcode-back" href="../../predictit.main.html#predictit.main.predict_multiple_columns">[docs]</a><span class="k">def</span> <span class="nf">predict_multiple_columns</span><span class="p">(</span><span class="o">**</span><span class="n">function_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Predict multiple colums and multiple frequencions at once. Use predict function.</span>

<span class="sd">    Args:</span>
<span class="sd">        data (np.ndarray, pd.DataFrame): Time series. Can be 2-D - more columns.</span>
<span class="sd">            !!! In Numpy array use data series as rows, but in dataframe use cols !!!. Defaults to [].</span>
<span class="sd">        predicted_columns (list, optional): List of indexes of predicted columns or it&#39;s names (dataframe). Defaults to None.</span>
<span class="sd">        freqs (str. &#39;H&#39; or &#39;D&#39; or &#39;M&#39;, optional): If date index available, resample data and predict in defined time frequency. Defaults to [].</span>
<span class="sd">        database_deploy (bool, optional): Whether deploy results to database !!!</span>
<span class="sd">            For every database it&#39;s necessary to adjust the database function. Defaults to 0.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray: All the predicted results.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">config_freezed</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>

    <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">function_kwargs</span><span class="p">)</span>

    <span class="n">freqs</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">freqs</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">freqs</span> <span class="k">else</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
    <span class="n">predicted_columns</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">predicted_columns</span> <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">predicted_columns</span> <span class="k">else</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">predictit</span><span class="o">.</span><span class="n">data_preprocessing</span><span class="o">.</span><span class="n">load_data</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">predicted_columns</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">predicted_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">([</span><span class="s1">&#39;number&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">predicted_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">predictions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">fi</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">freqs</span><span class="p">):</span>

        <span class="k">for</span> <span class="n">ci</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">predicted_columns</span><span class="p">):</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">predictions</span><span class="p">[</span><span class="n">f</span><span class="s2">&quot;Column: </span><span class="si">{c}</span><span class="s2"> - Freq: </span><span class="si">{f}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">predicted_column</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">traceback_warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Error in making predictions on column </span><span class="si">{c}</span><span class="s2"> and freq </span><span class="si">{f}</span><span class="s2">&quot;</span><span class="p">)</span>


        <span class="c1"># if config.database_deploy:</span>
        <span class="c1">#     try:</span>
        <span class="c1">#         predictit.database.database_deploy(config.server, config.database, last_date, predictions[0], predictions[1], freq=f)</span>
        <span class="c1">#     except Exception:</span>
        <span class="c1">#         traceback_warning(f&quot;Error in database deploying on freq {f}&quot;)</span>

    <span class="c1"># Return original config values before predict function</span>
    <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config_freezed</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">predictions</span></div>


<div class="viewcode-block" id="compare_models"><a class="viewcode-back" href="../../predictit.main.html#predictit.main.compare_models">[docs]</a><span class="k">def</span> <span class="nf">compare_models</span><span class="p">(</span><span class="o">**</span><span class="n">function_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function that helps to choose apropriate models. It evaluate it on test data and then return results.</span>
<span class="sd">    After you know what models are the best, you can use only them in functions predict() or predict_multiple_columns.</span>
<span class="sd">    You can define your own test data and find best modules for your process. You can pickle data if you are use it</span>
<span class="sd">    more often to faster loading.</span>

<span class="sd">    Args:</span>
<span class="sd">        data_all (dict): Dictionary of data names and data values (np.array). You can use data from test_data module, generate_test_data script (e.g. gen_sin()).</span>
<span class="sd">        **kwargs (dict): All parameters of predict function. Check config.py for parameters details.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">config_freezed</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">freeze</span><span class="p">()</span>

    <span class="c1"># Edit config.py default values with arguments values if exist</span>
    <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">function_kwargs</span><span class="p">)</span>

    <span class="c1"># Edit config.py default values with arguments values if exist</span>
    <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;return_type&#39;</span><span class="p">:</span> <span class="s1">&#39;models_error_criterion&#39;</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span> <span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="s1">&#39;confidence_interval&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;optimizeit&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>

    <span class="c1"># If no data_all inserted, default will be used</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="o">.</span><span class="n">data_all</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">data_all</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;sin&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">predictit</span><span class="o">.</span><span class="n">test_data</span><span class="o">.</span><span class="n">generate_test_data</span><span class="o">.</span><span class="n">gen_sin</span><span class="p">(),</span> <span class="mi">0</span><span class="p">),</span>
                           <span class="s1">&#39;Sign&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">predictit</span><span class="o">.</span><span class="n">test_data</span><span class="o">.</span><span class="n">generate_test_data</span><span class="o">.</span><span class="n">gen_sign</span><span class="p">(),</span> <span class="mi">0</span><span class="p">),</span>
                           <span class="s1">&#39;Random data&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">predictit</span><span class="o">.</span><span class="n">test_data</span><span class="o">.</span><span class="n">generate_test_data</span><span class="o">.</span><span class="n">gen_random</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)}</span>
        <span class="n">predictit</span><span class="o">.</span><span class="n">misc</span><span class="o">.</span><span class="n">user_warning</span><span class="p">(</span><span class="s2">&quot;Test data was used. Setup &#39;data_all&#39; in config...&quot;</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">unstardized_results</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">data_dict</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">data_all</span>
    <span class="n">same_data</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data_dict</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">same_data</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">f</span><span class="s2">&quot;Data </span><span class="si">{i}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">predicted_column</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)}</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">data_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

        <span class="n">config</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">same_data</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">predicted_column</span> <span class="o">=</span> <span class="n">j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">predict</span><span class="p">()</span>
            <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">result</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">result</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
            <span class="n">unstardized_results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">traceback_warning</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Comparison for data </span><span class="si">{i}</span><span class="s2"> didn&#39;t finished.&quot;</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

    <span class="n">results_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">unstardized_results_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">unstardized_results</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># results_array[np.isnan(results_array)] = np.inf</span>

    <span class="n">all_data_average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">results_array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">unstardized_all_data_average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">unstardized_results_array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">models_best_results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">unstardized_models_best_results</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">all_data_average</span><span class="p">:</span>
        <span class="n">models_best_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">models_best_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">models_best_results</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">unstardized_all_data_average</span><span class="p">:</span>
        <span class="n">unstardized_models_best_results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">unstardized_models_best_results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">unstardized_models_best_results</span><span class="p">)</span>

    <span class="n">best_compared_model</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">models_best_results</span><span class="p">))</span>
    <span class="n">best_compared_model_name</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">used_models</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">best_compared_model</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Table of complete results. Percentual standardized error is between 0 and 1. If 0, model was the best on all defined data, 1 means it was the worst.&quot;</span><span class="p">)</span>
    <span class="n">models_table</span> <span class="o">=</span> <span class="n">PrettyTable</span><span class="p">()</span>
    <span class="n">models_table</span><span class="o">.</span><span class="n">field_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Model&#39;</span><span class="p">,</span> <span class="s1">&#39;Percentual standardized error&#39;</span><span class="p">,</span> <span class="s1">&#39;Error average&#39;</span><span class="p">]</span>

    <span class="c1"># Fill the table</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">used_models</span><span class="p">):</span>
        <span class="n">models_table</span><span class="o">.</span><span class="n">add_row</span><span class="p">([</span><span class="n">j</span><span class="p">,</span> <span class="n">models_best_results</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">unstardized_models_best_results</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> </span><span class="si">{models_table}</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Best model is </span><span class="si">{best_compared_model_name}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># If config value optimization</span>
    <span class="k">if</span> <span class="n">all_data_average</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No config variable optimization was applied&quot;</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">all_lengths_average</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">all_data_average</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">best_all_lengths_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanargmin</span><span class="p">(</span><span class="n">all_lengths_average</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">Best data length index is </span><span class="si">{best_all_lengths_index}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Return original config values before predict function</span>
    <span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config_freezed</span><span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span> <span class="ow">and</span> <span class="n">config</span><span class="o">.</span><span class="n">used_function</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">used_function</span> <span class="o">==</span> <span class="s1">&#39;predict&#39;</span><span class="p">:</span>
        <span class="n">prediction_results</span> <span class="o">=</span> <span class="n">predict</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">used_function</span> <span class="o">==</span> <span class="s1">&#39;predict_multiple&#39;</span><span class="p">:</span>
        <span class="n">prediction_results</span> <span class="o">=</span> <span class="n">predict_multiple_columns</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">used_function</span> <span class="o">==</span> <span class="s1">&#39;compare_models&#39;</span><span class="p">:</span>
        <span class="n">compare_models</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div id="logo">
<a href="https://predictit.readthedocs.io/">
    <img logo" src="https://predictit.readthedocs.io/en/master/_static/logo.png" alt="Logo">
</a>

<div class="section" id="table-of-contents">
<h3>Table of contents</h3>
<div class="toctree-wrapper compound">
<ul>

    <li class="toctree-l1"><a class="reference internal" href="https://predictit.readthedocs.io/en/master/">predictit</a>
    <ul>
        <li class="toctree-l2"><a class="reference internal" href="https://predictit.readthedocs.io/en/master/#output">Output</a></li>
        <li class="toctree-l2"><a class="reference internal" href="https://predictit.readthedocs.io/en/master/#installation">Installation</a></li>
        <li class="toctree-l2"><a class="reference internal" href="https://predictit.readthedocs.io/en/master/#how-to">How to</a>
        <ul>
            <li class="toctree-l3"><a class="reference internal" href="https://predictit.readthedocs.io/en/master/#simple-example-with-pypi">Simple example with Pypi</a></li>
            <li class="toctree-l3"><a class="reference internal" href="https://predictit.readthedocs.io/en/master/#example-with-own-data-from-csv-and-config">Example with own data from CSV and config</a></li>
        </ul></li>

        <li class="toctree-l2"><a class="reference internal" href="https://predictit.readthedocs.io/en/master/#submodules">Submodules</a>
        <ul>
            <li class="toctree-l3"><a class="reference internal" href="https://predictit.readthedocs.io/en/master/predictit.config/">configuration</a></li>
            <li class="toctree-l3"><a class="reference internal" href="https://predictit.readthedocs.io/en/master/predictit.main/">main</a></li>
            <li class="toctree-l3"><a class="reference internal" href="https://predictit.readthedocs.io/en/master/predictit.analyze">analyze</a></li>
            <li class="toctree-l3"><a class="reference internal" href="https://predictit.readthedocs.io/en/master/predictit.best_params/">best_params</a></li>
            <li class="toctree-l3"><a class="reference internal" href="https://predictit.readthedocs.io/en/master/predictit.confidence_interval/">confidence_interval</a></li>
            <li class="toctree-l3"><a class="reference internal" href="https://predictit.readthedocs.io/en/master/predictit.database/">database</a></li>
            <li class="toctree-l3"><a class="reference internal" href="https://predictit.readthedocs.io/en/master/predictit.data_prep/">data_prep</a></li>
            <li class="toctree-l3"><a class="reference internal" href="https://predictit.readthedocs.io/en/master/predictit.evaluate_predictions/">evaluate_predictions</a></li>
            <li class="toctree-l3"><a class="reference internal" href="https://predictit.readthedocs.io/en/master/predictit.main_for_develop/">main_for_develop</a></li>
        </ul></li>

        <li class="toctree-l2"><a class="reference internal" href="https://predictit.readthedocs.io/en/master/#subpackages">Subpackages</a>
        <ul>
            <li class="toctree-l3"><a class="reference internal" href="https://predictit.readthedocs.io/en/master/predictit.models/">models</a></li>
            <li class="toctree-l3"><a class="reference internal" href="https://predictit.readthedocs.io/en/master/predictit.test_data/">test_data</a></li>
        </ul></li>
        <li class="toctree-l2"><a class="reference internal" href="https://predictit.readthedocs.io/en/master/genindex/">Index</a></li>
    </ul></li>

</ul>
</div>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2020, Daniel Malachov.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    
    <a href="https://github.com/Malachov/predictit" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>